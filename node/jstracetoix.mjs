// --------------------------------------------------------------------
// Copyright (c) 2024 Alexandre Bento Freire. All rights reserved.
// Licensed under the MIT license
// --------------------------------------------------------------------
"use strict";import{threadId as N}from"worker_threads";export const DEFAULT_FORMAT={result:"{name}:`{value}`",input:"{name}:`{value}`",thread:"{id}: ",sep:" | ",new_line:!0};let h=process.stdout,m=!1,I=DEFAULT_FORMAT,i={},p={},O=new SharedArrayBuffer(4),A=new Int32Array(O);const y=()=>{if(m)for(;Atomics.compareExchange(A,0,0,1)!==0;);},b=()=>{m&&Atomics.store(A,0,0)},w=(n=void 0)=>n||N;export const init__=({stream:n=h,multithreading:s=!1,format:r=DEFAULT_FORMAT}={})=>{y(),h=n,m=s,I=r,i={},p={},b()},t__=(n=void 0,s=void 0)=>{y(),p[w(s)]=n||`t${Object.keys(p).length}`,b()},c__=(n,s)=>{const{name:r=void 0,allow:o=void 0,level:u=0}=s||{};y();const _=w();for(i[_]||(i[_]=[{index__:0,meta__:["meta__","index__"]}]);i[_].length<=u;)i[_].push({index__:0,meta__:["meta__","index__"]});const d=i[_][u],a=d.index__,l=d.meta__.length;let f=typeof r=="function"?r(a,Object.keys(d).length-l,n):r||`i${Object.keys(d).length-l}`,e=n,t=o;return typeof o=="function"&&(t=o(a,f,n),typeof t!="boolean"&&(e=t,t=!0)),(t===void 0||t)&&(d[f]=e),d.index__=a+1,b(),n},d__=(n,s={})=>{let{name:r="_",allow:o=void 0,before:u=void 0,after:_=void 0,inputs:d=void 0,format:a=void 0}=s||{};y();const l=w(),f=i[l]||[{}],e={...f[f.length-1],...d||{}};if(e.thread_id__=l,e.input_count__=e.index__||0,e.allow__=!0,e.meta__=[...e.meta__||["meta__"],"allow__","allow_input_count__","input_count__","thread_id__",r],e[r]=n,delete e.index__,e.meta__=e.meta__.filter(t=>t!=="index__"),e.allow_input_count__=Object.keys(e).length-e.meta__.length+1,typeof o=="function"&&(o=o(e),typeof o!="boolean"&&(e[r]=o,o=!0)),o!==!1){a=a||I;let t="";m&&a.thread&&(t+=a.thread.replace("{id}",p[l]||`${l}`));const x=(c,k,g)=>c.replace("{name}",k).replace("{value}",typeof g=="object"?JSON.stringify(g):g);for(const c in e)e.meta__.includes(c)||(t+=x(a.input,c,e[c])+a.sep);a.result&&(t+=x(a.result,r,e[r])),e.meta__+=["output__"],e.output__=t,(u===void 0||u(e))&&(t=e.output__+(a.new_line?`
`:""),h.write(t))}else e.allow__=!1;return _&&_(e),i[l]&&(i[l].pop(),i[l].length===0&&delete i[l]),b(),n};
//# sourceMappingURL=jstracetoix.mjs.map
